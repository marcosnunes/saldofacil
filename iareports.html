<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Relat√≥rios IA</title>
    <script>
        (function (w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                "gtm.start": new Date().getTime(),
                event: "gtm.js",
            });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != "dataLayer" ? "&l=" + l : "";
            j.async = true;
            j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, "script", "dataLayer", "GTM-54RF6LLM");
    </script>
    <meta charset="UTF-8" />
    <meta name="google" content="translate" />
    <meta name="description" content="Calculadora de Investimentos" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="favicon.ico" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-54RF6LLM" height="0" width="0"
            style="display: none; visibility: hidden"></iframe></noscript>
    <div class="navigation">
        <div class="nav-wrapper">
            <button id="backButton" class="btn btn-default">Voltar</button>
            <span class="brand-logo center">Assistente</span>
            <button id="nextButton" class="btn btn-default">Pr√≥ximo</button>
        </div>
    </div>
    <div class="container">
        <div class="card">
            <div class="card-content">
                <div id="reportArea">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-content">
                <h5>Pergunte √† IA sobre seus Gastos</h5>
                <input type="text" id="userQuestion" placeholder="Fa√ßa sua pergunta..." />
                <button id="askButton" class="btn btn-default">Perguntar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script type="module">
        const urlParams = new URLSearchParams(window.location.search);
        const currentYear = urlParams.get('year');

        const API_URL = '/api/ask-gemini';

        const LOCAL_STORAGE_KEY = `report_data_${currentYear}`;

        const askButton = document.getElementById("askButton");
        const userQuestionInput = document.getElementById("userQuestion");
        const reportArea = document.getElementById("reportArea");

        if (!currentYear) {
            console.warn(
                "iareports.html - Par√¢metro 'year' n√£o encontrado na URL!"
            );
            reportArea.innerHTML = "<p>Erro: Ano n√£o especificado na URL.</p>";
        }

        function loadDataFromLocalStorage() {
            try {
                const jsonData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (jsonData) {
                    const data = JSON.parse(jsonData);
                    console.log("Dados carregados do localStorage:", data);
                    return data;
                } else {
                    console.log(`Nenhum dado encontrado no localStorage para a chave: ${LOCAL_STORAGE_KEY}`);
                    return null;
                }
            } catch (error) {
                console.error("Erro ao carregar do localStorage:", error);
                return null;
            }
        }

        async function askGemini() {
            const question = userQuestionInput.value.trim();
            if (!question) return;

            askButton.disabled = true;
            reportArea.textContent = "ü§ñ Pensando na sua resposta...";

            const decoder = new TextDecoder("utf-8");

            try {
                const response = await fetch("/api/ask-gemini", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        question: question,
                        dadosDoUsuario: dadosUsuario
                    }),
                });

                if (response.ok) {
                    const reader = response.body.getReader();
                    reportArea.textContent = "";
                    let finalResponseText = '';

                    while (true) {
                        const { done, value } = await reader.read();

                        if (done) {
                            break;
                        }
                        const chunk = decoder.decode(value, { stream: true });
                        reportArea.textContent += chunk;
                        finalResponseText += chunk;
                    }
                    console.log("Resposta final do Gemini:", finalResponseText);

                }

                else {
                    try {
                        const errorData = await response.json();
                        reportArea.textContent = `Erro do Servidor: ${errorData.error}`;
                    } catch (e) {
                        reportArea.textContent = `Erro de Conex√£o ou Timeout: Status ${response.status} (${response.statusText}). Tente novamente.`;
                    }
                }

            } catch (error) {
                console.error("Erro na requisi√ß√£o Fetch:", error);
                reportArea.textContent = "Erro de rede: N√£o foi poss√≠vel conectar ao servidor Vercel/Gemini.";
            } finally {
                askButton.disabled = false;
            }
        }

        function handleGesture() {
            if (
                touchendX < touchstartX &&
                Math.abs(touchendX - touchstartX) > gestureZone
            ) {
                window.history.forward();
            }
            else if (
                touchendX > touchstartX &&
                Math.abs(touchendX - touchstartX) > gestureZone
            ) {
                window.history.back();
            }
        }

        askButton.addEventListener("click", askGemini);

        userQuestionInput.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                askGemini();
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            if (currentYear) {
                reportArea.textContent =
                    "Ol√°! Eu sou o Gemini. Pergunte-me sobre seus gastos.";
            }
        });

        document
            .getElementById("backButton")
            .addEventListener("click", function () {
                window.history.back();
            });
        document
            .getElementById("nextButton")
            .addEventListener("click", function () {
                window.history.forward();
            });

        let touchstartX = 0;
        let touchendX = 0;
        const gestureZone = 50;

        document.addEventListener("touchstart", function (event) {
            touchstartX = event.changedTouches[0].screenX;
        });

        document.addEventListener("touchend", function (event) {
            touchendX = event.changedTouches[0].screenX;
            handleGesture();
        });

    </script>
</body>

</html>