<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Relatórios IA</title>
    <script>
        (function (w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                "gtm.start": new Date().getTime(),
                event: "gtm.js",
            });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != "dataLayer" ? "&l=" + l : "";
            j.async = true;
            j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, "script", "dataLayer", "GTM-54RF6LLM");
    </script>
    <meta charset="UTF-8" />
    <meta name="google" content="translate" />
    <meta name="description" content="Calculadora de Investimentos" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="favicon.ico" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-54RF6LLM" height="0" width="0"
            style="display: none; visibility: hidden"></iframe></noscript>
    <div class="navigation">
        <div class="nav-wrapper">
            <button id="backButton" class="btn btn-default">Voltar</button>
            <span class="brand-logo center">Assistente</span>
            <button id="nextButton" class="btn btn-default">Próximo</button>
        </div>
    </div>
    <div class="container">
        <div class="card">
            <div class="card-content">
                <div id="reportArea">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-content">
                <h5>Pergunte à IA sobre seus Gastos</h5>
                <input type="text" id="userQuestion" placeholder="Faça sua pergunta..." />
                <button id="askButton" class="btn btn-default">Perguntar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const urlParams = new URLSearchParams(window.location.search);
        const currentYear = urlParams.get('year');

        const API_KEY = "AIzaSyBUfrCQy-Y0aEXSQHnnLeqHj9sRQ3LRkuY";
        const MODEL_NAME = "gemini-2.5-pro";

        const LOCAL_STORAGE_KEY = `report_data_${currentYear}`;

        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: MODEL_NAME });

        const askButton = document.getElementById("askButton");
        const userQuestionInput = document.getElementById("userQuestion");
        const reportArea = document.getElementById("reportArea");

        if (!currentYear) {
            console.warn(
                "iareports.html - Parâmetro 'year' não encontrado na URL!"
            );
            reportArea.innerHTML = "<p>Erro: Ano não especificado na URL.</p>";
        }

        function loadDataFromLocalStorage() {
            try {
                const jsonData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (jsonData) {
                    const data = JSON.parse(jsonData);
                    console.log("Dados carregados do localStorage:", data);
                    return data;
                } else {
                    console.log(`Nenhum dado encontrado no localStorage para a chave: ${LOCAL_STORAGE_KEY}`);
                    return null;
                }
            } catch (error) {
                console.error("Erro ao carregar do localStorage:", error);
                return null;
            }
        }

        async function askGemini() {
            const question = userQuestionInput.value;

            if (!question) {
                reportArea.innerHTML = "<p>Por favor, digite uma pergunta.</p>";
                return;
            }

            reportArea.innerHTML = `
                <p style="text-align: center;">Pensando...</p>
                <div class="progress">
                    <div class="indeterminate"></div>
                </div>
            `;
            askButton.disabled = true;
            userQuestionInput.disabled = true;

            try {
                const dadosDoUsuario = loadDataFromLocalStorage();

                const contextoDosDados = dadosDoUsuario
                    ? JSON.stringify(dadosDoUsuario, null, 2)
                    : "Não há dados de gastos disponíveis.";

                const prompt = `
                    Você é um assistente financeiro. 
                    Analise os seguintes dados do usuário (em formato JSON):
                    
                    --- Início dos Dados ---
                    ${contextoDosDados}
                    --- Fim dos Dados ---
                    
                    Com base APENAS nos dados fornecidos acima, 
                    responda à seguinte pergunta do usuário:
                    "${question}"
                `;

                console.log("Enviando para a IA:", prompt);

                const result = await model.generateContent(prompt);
                const response = await result.response;
                const text = await response.text();

                const formattedText = text.replace(/\n/g, '<br>');

                reportArea.innerHTML = formattedText;

            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                reportArea.innerHTML = `<p style="color: red;">Desculpe, ocorreu um erro ao processar sua pergunta. Verifique o console para mais detalhes.</p>`;
            } finally {
                askButton.disabled = false;
                userQuestionInput.disabled = false;
                userQuestionInput.value = "";
            }
        }

        function handleGesture() {
            if (
                touchendX < touchstartX &&
                Math.abs(touchendX - touchstartX) > gestureZone
            ) {
                window.history.forward();
            }
            else if (
                touchendX > touchstartX &&
                Math.abs(touchendX - touchstartX) > gestureZone
            ) {
                window.history.back();
            }
        }

        askButton.addEventListener("click", askGemini);

        userQuestionInput.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                askGemini();
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            if (currentYear) {
                reportArea.textContent =
                    "Olá! Eu sou o Gemini. Pergunte-me sobre seus gastos.";
            }
        });

        document
            .getElementById("backButton")
            .addEventListener("click", function () {
                window.history.back();
            });
        document
            .getElementById("nextButton")
            .addEventListener("click", function () {
                window.history.forward();
            });

        let touchstartX = 0;
        let touchendX = 0;
        const gestureZone = 50;

        document.addEventListener("touchstart", function (event) {
            touchstartX = event.changedTouches[0].screenX;
        });

        document.addEventListener("touchend", function (event) {
            touchendX = event.changedTouches[0].screenX;
            handleGesture();
        });

    </script>
</body>

</html>