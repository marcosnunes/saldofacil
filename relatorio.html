<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Relatório</title>
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-54RF6LLM');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8" />
    <meta name="google" content="translate" />
    <meta name="description" content="Calculadora de Investimentos" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="favicon.ico" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-54RF6LLM" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="navigation">
        <div class="nav-wrapper">
            <button id="backButton" class="btn btn-default">Voltar</button>
            <span class="brand-logo center">Relatório</span>
            <button id="nextButton" class="btn btn-default">Próximo</button>
        </div>
    </div>
    <div class="main-content">
        <div class="container">

            <div class="card" id="opcoes_relatorio">
                <div class="card-content">
                    <span class="card-title">Opções do Relatório</span>
                    <div class="input-field">
                        <i class="material-icons prefix">monetization_on</i>
                        <select id="currencySelect">
                            <option value="BRL" selected>Real (R$)</option>
                            <option value="EUR">Euro (€)</option>
                            <option value="USD">Dólar ($)</option>
                            <option value="GBP">Libra Esterlina (£)</option>
                        </select>
                        <label>Converter Moeda</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-content">
                    <span class="card-title">Totais do Ano</span>
                    <div class="card-balance-content">
                        <div class="card-content">
                            <span class="card-title">Total Crédito</span>
                            <p id="creditTotal" class="green-text">0.00</p>
                        </div>
                        <div class="card-content">
                            <span class="card-title">Total Débito</span>
                            <p id="debitTotal" class="orange-text">0.00</p>
                        </div>
                        <div class="card-content">
                            <span class="card-title">Cartão de Crédito</span>
                            <p id="creditCardBalance" class="orange-text">0.00</p>
                        </div>
                        <div class="card-content">
                            <span class="card-title">Balanço</span>
                            <p id="balance">0.00</p>
                            <p id="balancePercentage">0.00%</p>
                        </div>
                    </div>
                    <div class="card-action"
                        style="display: flex; justify-content: space-between; align-items: center; padding-top: 24px;">
                        <button id="pdfButton" onclick="window.print()" class="btn">Exportar para PDF</button>
                        <a id="askAiButton" class="btn" style="background-color: var(--color-success);">Perguntar à
                            IA</a>
                    </div>
                </div>
            </div>

            <div class="card">
                <div id="report" class="card-content">
                    <span class="card-title">Extrato Anual Detalhado</span>
                    <div id="launchDataContainer">
                        <!-- Lançamentos anuais serão inseridos aqui pelo JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script type="module">
        import { displayYearInTitle } from "./utils.js";
        displayYearInTitle();

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import firebaseConfig from "./config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const months = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];

        const urlParams = new URLSearchParams(window.location.search);
        let currentYear = urlParams.get("year");
        const LOCAL_STORAGE_KEY = `report_data_${currentYear}`;

        let debitTotal = 0;
        let creditTotal = 0;
        let creditCardBalanceTotal = 0;
        let balance = 0;
        let percentage = 0;
        let annualLaunches = {}; // Armazena os lançamentos agrupados

        function saveDataToLocalStorage(data) {
            try {
                const jsonData = JSON.stringify(data);
                localStorage.setItem(LOCAL_STORAGE_KEY, jsonData);
                console.log("Dados salvos no localStorage.");
            } catch (error) {
                console.error("Erro ao salvar no localStorage:", error);
            }
        }

        function loadMonthData(userId, month, year) {
            return new Promise((resolve, reject) => {
                const monthRef = ref(database, `users/${userId}/${month}-${year}`);
                onValue(monthRef, (snapshot) => {
                    resolve(snapshot.val() || {});
                }, (error) => reject(error), { onlyOnce: true });
            });
        }

        function loadAllCreditCardData(userId, year) {
            return new Promise((resolve, reject) => {
                const creditCardRef = ref(database, `creditCardData/${userId}/${year}`);
                onValue(creditCardRef, (snapshot) => {
                    resolve(snapshot.val() || {});
                }, (error) => reject(error), { onlyOnce: true });
            });
        }

        function calculateAndPrepareData(yearData) {
            // Reseta os valores globais
            debitTotal = 0;
            creditTotal = 0;
            creditCardBalanceTotal = 0;
            annualLaunches = {};

            // Processa transações mensais
            for (const month of months) {
                const monthData = yearData.monthlyTransactions[month];
                if (monthData) {
                    creditTotal += Number(monthData.totalCredit || 0);
                    debitTotal += Number(monthData.totalDebit || 0);
                    if (monthData.transactions) {
                        monthData.transactions.forEach((transaction) => {
                            const description = transaction.description;
                            const amount = (parseFloat(transaction.credit) || 0) - (parseFloat(transaction.debit) || 0);
                            annualLaunches[description] = (annualLaunches[description] || 0) + amount;
                        });
                    }
                }
            }

            // Processa transações do cartão de crédito
            if (yearData.creditCardTransactions) {
                for (const id in yearData.creditCardTransactions) {
                    const transaction = yearData.creditCardTransactions[id];
                    const description = transaction.description.split(' (')[0]; // Agrupa pelo nome base
                    const amount = - (parseFloat(transaction.value) || 0);
                    annualLaunches[description] = (annualLaunches[description] || 0) + amount;
                    creditCardBalanceTotal += parseFloat(transaction.value) || 0;
                }
            }

            debitTotal += creditCardBalanceTotal; // Adiciona o gasto do cartão ao débito total
            balance = creditTotal - debitTotal;
            percentage = creditTotal > 0 ? (debitTotal / creditTotal) * 100 : 0;
        }


        function displayAnnualLaunches() {
            const launchDataContainer = document.getElementById("launchDataContainer");
            launchDataContainer.innerHTML = "";

            const sortedDescriptions = Object.keys(annualLaunches).sort();

            if (sortedDescriptions.length === 0) {
                launchDataContainer.innerHTML = "<p>Nenhum lançamento encontrado para este ano.</p>";
                return;
            }

            const reportList = document.createElement('div');
            reportList.className = 'report-list';

            for (const description of sortedDescriptions) {
                const total = annualLaunches[description];
                const itemDiv = document.createElement("div");
                itemDiv.className = "report-item";

                const descriptionSpan = document.createElement("span");
                descriptionSpan.className = "description";
                descriptionSpan.textContent = description;

                const totalSpan = document.createElement("span");
                totalSpan.className = "total";
                totalSpan.classList.add(total >= 0 ? 'positive' : 'negative');
                totalSpan.setAttribute('data-base-value', total); // Armazena valor base em BRL

                itemDiv.appendChild(descriptionSpan);
                itemDiv.appendChild(totalSpan);
                reportList.appendChild(itemDiv);
            }
            launchDataContainer.appendChild(reportList);
        }

        function updateBalanceValues(currency, exchangeRate) {
            document.getElementById("debitTotal").textContent = formatCurrency(debitTotal * exchangeRate, currency);
            document.getElementById("creditTotal").textContent = formatCurrency(creditTotal * exchangeRate, currency);
            document.getElementById("creditCardBalance").textContent = formatCurrency(creditCardBalanceTotal * exchangeRate, currency);
            document.getElementById("balance").textContent = formatCurrency(balance * exchangeRate, currency);
            document.getElementById("balancePercentage").textContent = percentage.toFixed(2) + "%";

            // Atualiza a lista de lançamentos
            const launchItems = document.querySelectorAll('.report-item .total');
            launchItems.forEach(item => {
                const baseValue = parseFloat(item.getAttribute('data-base-value'));
                item.textContent = formatCurrency(baseValue * exchangeRate, currency);
            });
        }

        function formatCurrency(amount, currency) {
            const options = { style: 'currency', currency: currency };
            return new Intl.NumberFormat('pt-BR', options).format(amount);
        }

        function convertCurrency() {
            const selectedCurrency = document.getElementById("currencySelect").value;
            fetch(`https://open.er-api.com/v6/latest/BRL`)
                .then(response => response.json())
                .then(data => {
                    const exchangeRate = data.rates[selectedCurrency];
                    updateBalanceValues(selectedCurrency, exchangeRate);
                })
                .catch(error => console.error("Erro ao obter taxas de câmbio:", error));
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const monthDataPromises = months.map(month => loadMonthData(user.uid, month, currentYear));
                    const creditCardDataPromise = loadAllCreditCardData(user.uid, currentYear);

                    const results = await Promise.all([...monthDataPromises, creditCardDataPromise]);
                    const creditCardData = results.pop();
                    const monthlyResults = results;

                    const fullReportData = {
                        monthlyTransactions: {},
                        creditCardTransactions: creditCardData
                    };

                    months.forEach((month, index) => {
                        fullReportData.monthlyTransactions[month] = monthlyResults[index];
                    });

                    saveDataToLocalStorage(fullReportData);
                    calculateAndPrepareData(fullReportData);
                    displayAnnualLaunches();
                    convertCurrency();

                } catch (error) {
                    console.error("Erro ao carregar dados:", error);
                }
            } else {
                window.location.href = "login.html";
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            var elems = document.querySelectorAll("select");
            M.FormSelect.init(elems);
            document.getElementById("currencySelect").addEventListener("change", convertCurrency);
            document.getElementById("backButton").addEventListener("click", () => window.history.back());
            document.getElementById("nextButton").addEventListener("click", () => window.history.back());

            const askAiButton = document.getElementById('askAiButton');
            askAiButton.href = `iareports.html?year=${currentYear}`;
        });

        var touchstartX = 0;
        var touchendX = 0;
        var gestureZone = 50;

        document.addEventListener('touchstart', function (event) {
            touchstartX = event.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', function (event) {
            touchendX = event.changedTouches[0].screenX;
            handleGesture();
        });

        function handleGesture() {
            if (Math.abs(touchendX - touchstartX) > gestureZone) {
                window.history.back();
            }
        }
    </script>
</body>

</html>